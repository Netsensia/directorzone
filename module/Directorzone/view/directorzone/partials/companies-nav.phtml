
<div class="row">

<div class="col-md-4">

<ul class="nav nav-pills nav-stacked" style="max-width:250px;">
<?php 

foreach ($this->filters as $slug => $details) {
?>
    <li id="<?php echo $slug; ?>" class="filter <?php echo ($slug == 'live' ? 'active' : '') ?>">
        <a href="#">
            <?php echo $details['name'] . ' <span class="badge pull-right">' . $details['count'] . '</span>'; ?>
        </a>
    </li>
<?php
}

?>
</ul>
</div>
<div class="col-md-8">

<div class="fileinput fileinput-new" data-provides="fileinput">
  <div class="input-group">
    <div class="form-control uneditable-input span3" data-trigger="fileinput"><i class="glyphicon glyphicon-file fileinput-exists"></i> <span class="fileinput-filename"></span></div>
    <span class="input-group-addon btn btn-default btn-file"><span class="fileinput-new">Select file</span>
    <span class="fileinput-exists">Change</span>
    <input id="fileupload" type="file" name="files[]" data-url="/admin/upload/companies" multiple>
    </span>
    <a href="#" class="input-group-addon btn btn-default fileinput-exists" data-dismiss="fileinput">Remove</a>
  </div>
</div>

<div id="progress" style="display:none">
    <div class="bar" style="height:18px;background-color:#428bca">
    </div>
</div>
        
<table id="companies" class="table">
<tr><th>Number</th><th>Name</th><th>CEO</th></tr>
</table>

<ul class="pager">
  <li class="previous" id="previous" class="disabled"><a href="#">&larr; Previous</a></li>
  <li class="next" id="next"><a href="#">Next &rarr;</a></li>
</ul>

</div>

<script src="/js/jquery-file-upload/js/vendor/jquery.ui.widget.js"></script>
<script src="/js/jquery-file-upload/js/jquery.iframe-transport.js"></script>
<script src="/js/jquery-file-upload/js/jquery.fileupload.js"></script>
                                  
<script>


$(document).ready(function() {

	$('#fileupload').fileupload({
		type: 'json',
        done: function (e, data) {

            if (data.result.files[0].error) {
                alert(data.result.files[0].error);
            }

            window.location = '/admin/companies';
            
        },
        fail: function (e, data) {

            alert('There was an unexpected error.  ' +
            	  'The data may have uploaded successful anyway.  ' +
            	  'Please check the figures on the left after ' +
            	  'closing this box.');

            window.location = '/admin/companies';
            
        },
        progressall: function (e, data) {
            var progress = parseInt(data.loaded / data.total * 100, 10);
            $('#progress').css(
                    'display',
                    'block'
                );
            $('#progress .bar').css(
                'width',
                progress + '%'
            );
        },
    });

	var page = 1;
	var size = 10;
	var type = "L";

	$(".filter").click(function() {
		$(".filter").removeClass('active');
		$(this).addClass('active');
		page = 1;
		size = 10;
		switch ($(this).attr('id')) {
		  case 'live' : type = 'L'; break;
		  case 'pending' : type = 'P'; break;
		  case 'conflicts' : type = 'C'; break;
		  case 'companies-house' : type = 'H'; break;
		  case 'removed' : type = 'R'; break;
		  case 'unmatched' : type = 'U'; break;
		}

		loadTable(type, page, size);
	});

	$("li#next").click(function() {
		page ++;
		loadTable(type, page, size);
	});

	$("li#previous").click(function() {
		if (!$(this).hasClass('disabled')) {
    		page --;
    		loadTable(type, page, size);
		}
	});

	loadTable(type, page, size);
});

function loadTable(type, page, size)
{
	$('table#companies').find("tr:gt(0)").remove();


	$('table#companies tr:last').after(
		'<tr>' +
		'<td style="text-align:center" colspan="4"><img src="/img/ajax/ajax-loader.gif"></td>' +
		'</tr>'
    );
	
	var url = "/ajax/company/search?type=" + type + "&page=" + page + "&size=" + size;

	$.ajax({
		url: url
	}).done(function(data) {

		$('table#companies').find("tr:gt(0)").remove();
		
		$('li#next').removeClass('disabled');
		$('li#previous').removeClass('disabled');
		
		if (data.total <= page * size) {
			$('li#next').addClass('disabled');
		}

		if (page == 1) {
			$('li#previous').addClass('disabled');
		}
		
		$.each(data.results, function(key, value) {
    		$('table#companies tr:last').after(
    			'<tr>' +
    			'<td>' + value.number + '</td>' +
    			'<td>' + value.name + '</td>' +
    			'<td>' + JSON.stringify(value.searchResults) + '</td>' +
    			'</tr>'
    	    );
    	});
	});
}
</script>